# v3.0.15 "SPORTS Event-First Kalshi + MVE Truth + Matchability Audit"

## Goal
Убрать иллюзию "нет данных/нет пересечения" и реально разблокировать SPORTS matching, опираясь на НАТИВНЫЕ поля Kalshi API (events + mve fields), а не на title heuristics.

---

## Current State (v3.0.14)
- MVE backfill done: 99.10% MVE, 0.90% non-MVE
- Non-MVE eligible Kalshi: ~350
- Polymarket eligible: ~1,011
- **0 matches** - "нет пересечения лиг" (Kalshi = ESPORTS, PM = Football/NBA/NHL)

## Hypothesis
Kalshi game markets существуют, но pipeline их не видит из-за:
1. Events enrichment incomplete
2. Signal extraction из market title вместо event
3. Неправильный доступ к /events и nested markets

---

## BLOCK A: Kalshi API Truth MVE Detection

### A1: Prisma Schema Updates
```prisma
model Market {
  // existing...

  // v3.0.15: Kalshi MVE truth fields
  kalshiMveCollectionTicker String?   @map("kalshi_mve_collection_ticker")
  kalshiMveSelectedLegs     Json?     @map("kalshi_mve_selected_legs")
  isMve                     Boolean?  @map("is_mve")  // derived
}
```

### A2: Ingestion Parser Update
- Parse `mve_collection_ticker` and `mve_selected_legs` from API payload
- Compute `isMve`:
  ```typescript
  isMve = !!mve_collection_ticker ||
          (Array.isArray(mve_selected_legs) && mve_selected_legs.length > 0)
  ```
- Fallback only if both fields absent:
  ```typescript
  isMve = seriesTicker.startsWith('KXMV') || hasParlayPattern(title)
  ```

### A3: CLI Command
```bash
kalshi:mve:audit --lookback-hours N
```
Output:
- Total sports markets
- Share with mve_collection_ticker
- Share with mve_selected_legs
- Share only via fallback
- Top seriesTickers by MVE share

---

## BLOCK B: Kalshi Events Sync (Non-MVE Game Markets)

### B1: Event Sync Commands
```bash
kalshi:events:sync --series-ticker <TICKER> [--status open] [--with-nested]
kalshi:events:smart-sync --derived-topic SPORTS --non-mve-only --apply
```

### B2: KalshiEvent Model
Already exists, ensure fields:
- eventTicker (PK)
- seriesTicker
- title, subTitle
- category
- strikeDate
- closeTime (if available)
- marketCount

### B3: Repository Methods
- `getByTickers(tickers[])`
- `getMissingTickersFromMarkets({venue, derivedTopic, nonMveOnly, lookbackHours})`
- `coverageReport({derivedTopic, nonMveOnly})`

### B4: Coverage CLI
```bash
sports:event-coverage --venue kalshi --lookback-hours N
```
Output:
- Total markets (SPORTS)
- Non-MVE markets
- Unique eventTickers
- Events in DB
- Coverage %
- Sample missing tickers (20)

---

## BLOCK C: Sports Signals V4 (Event-First for Kalshi)

### C1: Dual Extractors
```typescript
extractSportsSignalsFromPolymarketMarket(market)  // existing
extractSportsSignalsFromKalshiMarket(market, event)  // NEW
```

### C2: Kalshi Event-First Rules
| Field | Source Priority |
|-------|-----------------|
| League | event.title + event.subTitle + market.title |
| Teams | 1) event.title/subTitle, 2) market.title |
| Time | 1) event.strikeDate, 2) market.closeTime |
| MarketType | market.title + seriesTicker patterns |

### C3: Eligibility V4
**Kalshi:**
- isMve === false
- league !== UNKNOWN
- teams >= 2 from event (or single-team with "@"/"vs" = weak)
- timeBucket !== null

**Polymarket:**
- V2 eligibility unchanged
- Add consistent marketType parsing

### C4: Eligible CLI
```bash
sports:eligible --venue kalshi --lookback-hours N --limit K
```

---

## BLOCK D: Sports Pipeline Matching V2

### D1: Event-Key Index
```
eventKey = league + normalizedTeamA + normalizedTeamB + timeBucket
```

### D2: Candidate Generation
- Index by eventKey
- Also by (league+teams) for time fuzz
- Time tolerance: exact OR ±30m

### D3: Hard Gates
- League match
- Teams match (order-insensitive)
- Time bucket exact/adjacent
- MarketType exact
- SPREAD/TOTAL: lineValue ±1.0
- MONEYLINE: no lineValue needed

### D4: Scoring
- eventScore: 0.75
- lineScore: 0.25
- Penalty if teams from market title (not event)
- Penalty if time from closeTime proxy

### D5: Auto-Confirm
- Score >= 0.93
- MONEYLINE only
- Teams exact + league exact + time exact

### D6: Auto-Reject
- Score < 0.55
- Any hard-gate mismatch

---

## BLOCK E: Sports Matchability Preflight

### E1: Command
```bash
sports:matchability --lookback-hours N
```

Output:
1. **By Venue - Eligible by League:**
   ```
   Kalshi:      NBA=0, NHL=0, NFL=0, ESPORTS=2, ...
   Polymarket:  NBA=751, NHL=768, NFL=346, ESPORTS=0, ...
   ```

2. **By Venue - Eligible by MarketType:**
   ```
   Kalshi:      MONEYLINE=2, SPREAD=0, TOTAL=0
   Polymarket:  MONEYLINE=3233, SPREAD=218, TOTAL=366
   ```

3. **Overlap Matrix:**
   ```
   League Overlap: NONE (Kalshi ESPORTS vs PM NFL/NBA/NHL)
   MarketType Overlap: MONEYLINE (2 vs 3233)
   ```

4. **Time Coverage:**
   ```
   Kalshi:      85% with eventTime, 15% closeTime proxy
   Polymarket:  100% closeTime only
   ```

5. **Exclusion Reasons (top 20 per venue)**

6. **Conclusion Banner:**
   ```
   ❌ NO OVERLAP: Kalshi has only ESPORTS (2 markets)
   ❌ NO OVERLAP: No NBA/NHL/NFL non-MVE on Kalshi
   ```

### E2: Preflight Flag
```bash
v3:suggest-matches --topic SPORTS --preflight-only
```

---

## BLOCK F: Ops Wiring + Watchlist

- Add SPORTS to ops:run:v3 default topics
- Watchlist priority:
  - 100: confirmed
  - 80: candidate-safe (moneyline high score)
  - 50: top suggested

---

## Tests Required

1. **MVE Detection:**
   - Truth fields detection
   - Fallback heuristics

2. **Sports Signals V4:**
   - extractSportsSignalsFromKalshiMarket
   - Team extraction from event title
   - Time bucket from closeTime

3. **Matchability:**
   - Stable output structure
   - Exclusion breakdown categories

---

## Deliverables

1. This release notes document
2. Commands to run:
   ```bash
   # Sync events
   kalshi:events:smart-sync --non-mve-only --apply

   # Check coverage
   sports:event-coverage --lookback-hours 168

   # Check matchability
   sports:matchability --lookback-hours 168

   # Dry run matching
   v3:suggest-matches --topic SPORTS --dry-run --lookback-hours 168

   # Full run
   ops:run:v3 --topics SPORTS --auto-confirm --auto-reject --apply
   ```

3. **DATA VERDICT** if still 0 suggestions

---

## Implementation Status

| Block | Status | Notes |
|-------|--------|-------|
| A: MVE Truth | ✅ Done | Schema + Adapter + Repo + CLI audit command |
| B: Events Sync | ✅ Done | 100% coverage for non-MVE (5,849 markets linked) |
| C: Signals V4 | ⬜ Pending | |
| D: Pipeline V2 | ⬜ Pending | |
| E: Matchability | ⬜ Pending | |
| F: Ops Wiring | ⬜ Pending | |
