# v3.0.6 - Kalshi Taxonomy Backfill + V3 Pipeline Registration

**Release Date:** 2026-01-23

## Overview

This release adds Kalshi taxonomy backfill (derivedTopic population) and registers all topic pipelines in the V3 engine. This enables `taxonomy:overlap` to show accurate counts from database derivedTopic values.

## New Commands

### `kalshi:taxonomy:backfill` - Backfill Kalshi derivedTopic

Populates `derivedTopic` for Kalshi markets using series-based classification from KalshiSeries cache.

```bash
# Dry-run (preview changes)
node services/worker/dist/cli.js kalshi:taxonomy:backfill --dry-run --limit 1000

# Apply changes
node services/worker/dist/cli.js kalshi:taxonomy:backfill --apply --limit 50000

# Force re-classify all markets (not just NULL)
node services/worker/dist/cli.js kalshi:taxonomy:backfill --apply --force

# Filter by current topic
node services/worker/dist/cli.js kalshi:taxonomy:backfill --apply --current-topic UNKNOWN
```

**Options:**
- `--dry-run` - Preview without writing to DB
- `--apply` - Write changes to DB
- `--limit <N>` - Max markets to process
- `--only-null` - Only process markets with NULL derivedTopic (default: true)
- `--force` - Force re-classify even if derivedTopic exists
- `--batch-size <N>` - Batch size for updates (default: 500)
- `--current-topic <topic>` - Filter by current derivedTopic (e.g., UNKNOWN)

**Classification Priority:**
1. Series ticker pattern matching (highest confidence)
2. Series category + tags from cached KalshiSeries
3. Title keyword analysis (fallback)

**Output:**
- Topic distribution statistics
- Sample markets per topic
- UNKNOWN rate percentage

### `taxonomy:overlap` Updates (v3.0.6)

Now uses DB `derivedTopic` by default instead of on-the-fly classification.

```bash
# Default: use DB derivedTopic
node services/worker/dist/cli.js taxonomy:overlap

# Live mode: classify on-the-fly (original v3.0.5 behavior)
node services/worker/dist/cli.js taxonomy:overlap --live

# With CSV output
node services/worker/dist/cli.js taxonomy:overlap --out overlap.csv
```

**New Options:**
- `--live` - Classify on-the-fly instead of using DB derivedTopic

**Improvements:**
- Shows warning when markets have NULL derivedTopic
- Suggests running `kalshi:taxonomy:backfill` to populate

## V3 Pipeline Registration

All topic pipelines are now registered with the V3 dispatcher:

| Topic | Pipeline | Version |
|-------|----------|---------|
| CRYPTO_DAILY | CryptoDailyPipeline | v3@3.0.6:CRYPTO_DAILY |
| CRYPTO_INTRADAY | CryptoIntradayPipeline | v3@3.0.6:CRYPTO_INTRADAY |
| MACRO | MacroPipelineV3 | v3@3.0.6:MACRO |
| RATES | RatesPipeline | v3@3.0.5:RATES |
| ELECTIONS | ElectionsPipeline | v3@3.0.0:ELECTIONS |
| COMMODITIES | CommoditiesPipelineV3 | v3@3.0.6:COMMODITIES |

### Crypto Daily Pipeline (v3.0.6)

Wraps legacy crypto matching with V3 interface:
- Excludes intraday markets (UPDOWN, 15MIN, etc.)
- Hard gates: entity match, date type compatible, ±1 day settle date
- Auto-confirm: score >= 0.90, exact date, numbers overlapping

### Crypto Intraday Pipeline (v3.0.6)

Wraps intraday crypto matching with V3 interface:
- Only INTRADAY_UPDOWN markets
- Hard gates: entity match, exact time bucket
- Auto-confirm: score >= 0.92, direction match

### Macro Pipeline V3 (v3.0.6)

Wraps legacy macro matching with V3 interface:
- Hard gates: entity overlap, period compatible
- Auto-confirm: score >= 0.88, exact period, entity overlap >= 0.8

### Commodities Pipeline V3 (v3.0.6)

Wraps commodities matching with V3 interface:
- Hard gates: underlying match, month compatible (±1)
- Auto-confirm: score >= 0.90, same date, comparator match

## Files Changed

**New:**
- `services/worker/src/commands/kalshi-taxonomy-backfill.ts`
- `services/worker/src/matching/pipelines/cryptoDailyPipeline.ts`
- `services/worker/src/matching/pipelines/cryptoIntradayPipeline.ts`
- `services/worker/src/matching/pipelines/macroPipelineV3.ts`
- `services/worker/src/matching/pipelines/commoditiesPipelineV3.ts`

**Modified:**
- `services/worker/src/cli.ts` - New kalshi:taxonomy:backfill command
- `services/worker/src/commands/index.ts` - New exports
- `services/worker/src/commands/taxonomy-overlap.ts` - DB derivedTopic default, --live flag
- `services/worker/src/matching/pipelines/index.ts` - New pipeline exports
- `services/worker/src/matching/registerPipelines.ts` - Register all pipelines
- `services/worker/src/matching/dispatcher.ts` - Add COMMODITIES to IMPLEMENTED_TOPICS

## Testing

```bash
# Run TypeScript check
pnpm typecheck

# Build all packages
pnpm build

# Test kalshi:taxonomy:backfill (dry-run)
node services/worker/dist/cli.js kalshi:taxonomy:backfill --dry-run --limit 1000

# Test taxonomy:overlap with DB mode
node services/worker/dist/cli.js taxonomy:overlap

# Test taxonomy:overlap with live mode
node services/worker/dist/cli.js taxonomy:overlap --live
```

## Migration Notes

1. **Run kalshi:series:sync first** to ensure KalshiSeries cache is populated
2. **Run kalshi:taxonomy:backfill** to populate derivedTopic for Kalshi markets
3. No database migrations required - uses existing derivedTopic column

## Server Deployment

```bash
ssh root@64.111.93.112
cd ~/data_module_v1
git pull
pnpm install
pnpm build

# Ensure series cache is populated
node services/worker/dist/cli.js kalshi:series:sync

# Run backfill
node services/worker/dist/cli.js kalshi:taxonomy:backfill --apply

# Verify with taxonomy:overlap
node services/worker/dist/cli.js taxonomy:overlap
```

## Known Issues

- First 50K Kalshi markets with NULL derivedTopic are predominantly SPORTS
- Run backfill multiple times or without limit to cover all markets
- RATES/MACRO/CRYPTO markets may require targeted backfill with --force
