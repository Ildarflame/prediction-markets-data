# v3.0.14 "SPORTS Unblocked: Non-MVE Lane + Event Enrichment + First Matches"

## Summary

Разблокировка SPORTS matching между Kalshi ↔ Polymarket. Основная проблема: 99.99% Kalshi SPORTS — это MVE/SGP (KXMV*), которые корректно исключаются, но блокируют весь pipeline.

**Цели:**
- Детектировать и исключать MVE markets
- Обогащать non-MVE markets через Events API
- Получить первые реальные match suggestions

**Success Criteria:**
1. `taxonomy:overlap` показывает SPORTS overlap, pipeline выдаёт >0 suggestions
2. Audit показывает MVE vs non-MVE breakdown
3. Pipeline явно исключает MVE
4. Event enrichment для Kalshi SPORTS markets
5. Нет regressions по другим топикам

---

## Current State (v3.0.13)

```
Kalshi SPORTS:
  Total: 651,519
  MVE (KXMV*): 651,479 (99.99%)
  Non-MVE: 40 (0.01%)
    - NBAGAME: 20
    - NHLGAME: 20

  Eligible: 4 (все Valorant esports)
  Event coverage: 0.1%

Polymarket SPORTS:
  Total: 8,135
  Eligible: 1,003
```

---

## BLOCK A: Kalshi Sports MVE Detection + Storage

### Problem
Нужно уметь:
- Детектить MVE markets
- Исключать их из eligible set
- Строить статистику

### Tasks

#### A.1 Database Schema
```prisma
// packages/db/prisma/schema.prisma

model Market {
  // ... existing fields

  // v3.0.14: MVE detection
  isMve       Boolean?  @map("is_mve")  // null = unknown, true = MVE, false = non-MVE

  @@index([venue, derivedTopic, isMve, closeTime])
}
```

#### A.2 MVE Detection Logic
```typescript
// packages/core/src/sports/mveDetection.ts

/**
 * Detect if Kalshi market is Multi-Variate Event (MVE/SGP)
 *
 * Sources of truth (in priority order):
 * 1. API field (if available) - metadata.is_multivariate or similar
 * 2. SeriesTicker prefix: KXMV*
 * 3. Title patterns: "yes X, yes Y", "SGP", "Same Game Parlay"
 */
export function detectMve(market: {
  metadata: Record<string, unknown> | null;
  title: string;
}): boolean {
  const metadata = market.metadata;

  // 1. Check API field
  if (metadata?.is_multivariate === true) return true;
  if (metadata?.is_multivariate === false) return false;

  // 2. Check seriesTicker prefix
  const seriesTicker = metadata?.seriesTicker as string | undefined;
  if (seriesTicker?.startsWith('KXMV')) return true;

  // 3. Check title patterns
  const title = market.title.toLowerCase();
  if (/^yes\s+\w+.*,\s*yes\s+/i.test(title)) return true;
  if (/same\s+game\s+parlay|sgp/i.test(title)) return true;
  if (title.split(',').length >= 3 && /yes\s+\w+/i.test(title)) return true;

  return false;
}
```

#### A.3 Backfill Command
```bash
# Backfill isMve for existing markets
kalshi:mve:backfill --batch-size 5000 --dry-run
kalshi:mve:backfill --batch-size 5000 --apply
```

#### A.4 CLI: Sports Breakdown
```bash
kalshi:sports:breakdown --lookback-h 720
```

Output:
```
=== Kalshi SPORTS Breakdown (v3.0.14) ===

Total SPORTS markets: 651,519
  MVE:     651,479 (99.99%)
  Non-MVE: 40 (0.01%)

Top 20 Non-MVE seriesTickers:
  KXNBAGAME: 20
  KXNHLGAME: 20
  ...

Sample MVE titles (10):
  1. yes Stephen Curry: 3+, yes Denver, yes Philadelphia...
  ...

Sample Non-MVE titles (10):
  1. Golden State at Minnesota Winner?
  ...
```

---

## BLOCK B: Kalshi Events Cache + Enrichment

### Problem
Kalshi markets часто не имеют startTime/teams в metadata. Нужно подтягивать event details.

### Tasks

#### B.1 Table Schema (already exists as kalshi_events)
```prisma
model KalshiEvent {
  id              Int       @id @default(autoincrement())
  eventTicker     String    @unique @map("event_ticker")
  seriesTicker    String    @map("series_ticker")
  title           String
  subTitle        String?   @map("sub_title")
  category        String?
  status          String?
  strikeDate      DateTime? @map("strike_date") @db.Timestamptz
  mutuallyExclusive Boolean @default(false) @map("mutually_exclusive")
  marketCount     Int       @default(0) @map("market_count")
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  @@index([seriesTicker])
  @@map("kalshi_events")
}
```

#### B.2 KalshiEventsRepository Methods
```typescript
// packages/db/src/repositories/kalshi-event.repository.ts

class KalshiEventRepository {
  // Existing methods...

  // v3.0.14: New methods
  async getMissingTickers(tickers: string[]): Promise<string[]>;
  async getByTickers(tickers: string[]): Promise<Map<string, KalshiEvent>>;
}
```

#### B.3 Smart Sync Enhancement
```bash
# Sync events for non-MVE SPORTS markets only
kalshi:events:smart-sync --topic SPORTS --non-mve-only --limit 5000 --apply
```

#### B.4 Coverage Command
```bash
kalshi:events:coverage --topic SPORTS --non-mve-only
```

Output:
```
=== Event Coverage (SPORTS, non-MVE only) ===

Markets with eventTicker:  40
Unique eventTickers:       40
Events in DB:              40
Linked markets:            40
Coverage:                  100%
```

---

## BLOCK C: Sports Eligibility v2 (Kalshi-specific)

### Problem
Сейчас Kalshi eligible = 4. Надо ослабить eligibility и опираться на event data.

### Tasks

#### C.1 Event Enrichment Function
```typescript
// services/worker/src/matching/signals/sportsSignals.ts

interface EnrichedSportsData {
  startTime: Date | null;
  startTimeSource: 'event' | 'market' | 'closeTime';
  teams: { teamA: string; teamB: string } | null;
  teamsSource: 'event' | 'market' | 'none';
  league: SportsLeague;
  leagueSource: 'series' | 'title' | 'category';
}

async function enrichKalshiSportsMarket(
  market: EligibleMarket,
  eventCache: Map<string, KalshiEvent>
): Promise<EnrichedSportsData> {
  const eventTicker = market.kalshiEventTicker ||
                      (market.metadata as any)?.eventTicker;

  if (eventTicker) {
    const event = eventCache.get(eventTicker);
    if (event) {
      return {
        startTime: event.strikeDate || market.closeTime,
        startTimeSource: event.strikeDate ? 'event' : 'closeTime',
        teams: extractTeamsFromEvent(event) || extractTeams(market.title),
        teamsSource: extractTeamsFromEvent(event) ? 'event' : 'market',
        league: detectLeagueFromSeries(event.seriesTicker) || detectLeague(market.title),
        leagueSource: 'series',
      };
    }
  }

  // Fallback to market-only extraction
  return {
    startTime: market.closeTime,
    startTimeSource: 'closeTime',
    teams: extractTeams(market.title),
    teamsSource: 'market',
    league: detectLeague(market.title),
    leagueSource: 'title',
  };
}
```

#### C.2 Eligibility Rules v2
```typescript
function isEligibleSportsMarketV3(
  signals: SportsSignals,
  market: { isMve?: boolean | null }
): { eligible: boolean; reason: string | null } {
  // Hard excludes
  if (market.isMve === true) {
    return { eligible: false, reason: 'mve_excluded' };
  }

  if (signals.quality.isExcluded) {
    return { eligible: false, reason: signals.quality.excludeReason };
  }

  // Require teams OR event teams
  if (!signals.eventKey.teamA_norm && !signals.eventKey.teamB_norm) {
    return { eligible: false, reason: 'missing_teams' };
  }

  // Require start time (allow closeTime fallback for Kalshi)
  if (!signals.eventKey.startBucket) {
    return { eligible: false, reason: 'missing_start_time' };
  }

  // Only MONEYLINE/WINNER for v1
  if (signals.line.marketType !== SportsMarketType.MONEYLINE) {
    return { eligible: false, reason: 'unsupported_market_type' };
  }

  return { eligible: true, reason: null };
}
```

#### C.3 Audit Command
```bash
v3:sports:audit --from kalshi --lookback-h 168
```

Output:
```
=== SPORTS Audit (v3.0.14) ===

Venue: kalshi
Total: 1,000

Exclusion breakdown:
  mve_excluded:          950 (95.0%)
  missing_teams:         10 (1.0%)
  missing_start_time:    5 (0.5%)
  unsupported_market_type: 15 (1.5%)
  ---
  ELIGIBLE:              20 (2.0%)

Sample per bucket...
```

---

## BLOCK D: Sports Pipeline Matching (Moneyline only)

### Hard Gates
1. **League exact match** (NBA ↔ NBA, NFL ↔ NFL)
2. **Teams match** (order-insensitive, normalized)
3. **Time bucket match** (exact OR ±30min)
4. **Market type** = MONEYLINE/WINNER only

### Scoring
```
league:  0.20 (hard gate, so always 1.0 if pass)
teams:   0.50 (jaccard on normalized team set)
time:    0.20 (1.0 exact, 0.7 adjacent)
text:    0.10 (title jaccard)
```

### Auto Rules
- **Auto-confirm:** score >= 0.93 AND both have 2 teams AND league+time exact
- **Auto-reject:** score < 0.55 OR league mismatch OR teams mismatch

### CLI
```bash
v3:suggest-matches --topic SPORTS --from kalshi --to polymarket --lookback-h 168
v3:best --topic SPORTS --min-score 0.85
v3:worst --topic SPORTS --max-score 0.70
```

---

## BLOCK E: ops:run:v3 Wiring

### Preflight Rule
```typescript
// Only include SPORTS if:
// 1. taxonomy:overlap shows SPORTS overlap > 0
// 2. non-MVE eligible >= 50
const includeSports = await checkSportsPreflight();
```

### KPI Metrics
```typescript
interface OpsKpi {
  // ... existing

  // v3.0.14
  sportsSuggested24h: number;
  sportsConfirmed24h: number;
  kalshiSportsNonMveEligible: number;
}
```

---

## BLOCK F: Tests

### Unit Tests
1. `detectMve()` - various patterns
2. `enrichKalshiSportsMarket()` - event cache + fallback
3. `isEligibleSportsMarketV3()` - all exclusion reasons
4. Hard gates - teams/time/league matching

### Smoke Test
```bash
# On fixture dataset
kalshi:sports:breakdown
kalshi:events:coverage --topic SPORTS --non-mve-only
v3:sports:audit --from kalshi
v3:suggest-matches --topic SPORTS --from kalshi --to polymarket --dry-run
```

---

## Implementation Order

| Phase | Block | Description | Files |
|-------|-------|-------------|-------|
| 1 | A.1 | Add isMve field to schema | schema.prisma |
| 1 | A.2 | MVE detection logic | core/sports/mveDetection.ts |
| 1 | A.3 | Backfill command | commands/kalshi-mve-backfill.ts |
| 1 | A.4 | Breakdown command | commands/kalshi-sports-breakdown.ts |
| 2 | B.2 | Events repo enhancements | kalshi-event.repository.ts |
| 2 | B.3 | Smart sync --non-mve-only | kalshi-events-smart-sync.ts |
| 2 | B.4 | Coverage command | kalshi-events-coverage.ts |
| 3 | C.1 | Event enrichment | sportsSignals.ts |
| 3 | C.2 | Eligibility v3 | sportsSignals.ts |
| 3 | C.3 | Audit command | sports-debug.ts |
| 4 | D | Pipeline matching | sportsPipeline.ts |
| 5 | E | ops:run wiring | ops-run-v3.ts |
| 6 | F | Tests | *.test.ts |

---

## Questions Before Implementation

1. **Kalshi API:** Есть ли в Kalshi markets endpoint поле `is_multivariate` или аналог? Или только heuristic по seriesTicker?

2. **Event teams extraction:** В kalshi_events.title формат "Lakers vs Celtics" или другой? Нужно ли парсить subTitle?

3. **Backfill scope:** Делать backfill isMve для ВСЕХ Kalshi markets или только SPORTS derivedTopic?

4. **Time tolerance:** ±30min для time bucket matching — это достаточно? Или нужно ±1h для разных timezone issues?

---

## Rollback Plan

Все изменения backward-compatible:
- `isMve` — nullable field, existing code не ломается
- New commands — additive
- Eligibility v3 — отдельная функция, v2 остаётся

При проблемах можно откатить на v3.0.13 без миграций.
